<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slides Player</title>
<style>
@font-face {
  font-family: amiri;
  src: url('res/amiri-regular.woff');
  }

:root {
  --sw:100vw; /* screen width */
  --sh:100vh; /* screen height */
  --pd:10px; /* padding */
  --w:calc("100% - 20px");
  --h:calc("100% - 20px");
  }

body {
  direction:rtl;
  font-family: amiri;
  margin:0;
  padding:0;
  border:0;
  }
h1 {
  color:#f00;
  text-shadow:1px 1px 2px rgba(0,0,0,0.5);
  font-size:50px;
  font-weight:400;
  text-align:center;
  margin:0.4em 0;
  }
h2 {
  color:#00f;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  font-size:40px;
  font-weight:400;
  text-align:center;
  margin:0.4em 0;
  }
s-t {
  display:block;
  color:#00f;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  font-size:40px;
  font-weight:400;
  text-align:center;
  margin:0.5em 0;
  }
a-u {
  display:block;
  color:#000;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  font-size:40px;
  font-weight:400;
  text-align:center;
  margin:0.5em 0;
  }
li {
  font-size:28px;
  }
label {
  font-size:24px;
  color:#900;
  }
label img{
  height:50px;
  vertical-align:middle;
  }
input[type=radio] {
  transform:scale(1.4);
  /* visibility:hidden; */
  }
input[type=text] {
  font-size:24px;
  font-family:amiri;
  width:220px;
  border:1px #ddd solid;
  border-radius:5px;
  }
#vid {
  min-height:100%;
  }
s-l {
  position: absolute;
  display: block;
  width:calc(100% - (2 * var(--pd)));
  min-height:calc(100% - (2 * var(--pd)));
  /* border:1px red solid; */
  margin:0px;
  padding:var(--pd);
  }
s-l p {
  font-size:28px;
  margin:0px;
  }
#sb {
  padding:0;
  }
#dimg {
  text-align: center;
  position: relative;
  height:100px;
  display: flex;
  justify-content: center;
  }
#title_img {
  height:100px;
  text-align: center;
  position: absolute;
  top: 0;
  }
#vpb {
  /* box-sizing: border-box; */
  /* padding: 10px calc(50% - 50px); */
  display: block;
  opacity: 0.6;
  cursor: pointer;
  transition: opacity 150ms;
  z-index: 99;
  /* position: absolute; */
  /* top: 0; */
  }
#vpb:hover {
  opacity: 1;
  }
#time {
  position:absolute;
  top:0;
  left:0;
  font-family:Verdana;
  }
#cb {
  margin:20px;
  border:1px #ccc solid;
  border-radius:5px;
  font-family:amiri;
  font-size:24px;
  /* visibility:hidden; */
  opacity:0;
  transition: opacity 0.5s;
  }
#ft {
  direction:ltr;
  border:1px #ccc solid;
  display:flex;
  justify-content: center;
  position:fixed;
  bottom:-70px;
  width:100%;
  background-color:#fff;
  border-top:1px #ccc solid;
  transition: bottom 0.3s;
  /* visibility:hidden; */
  }
#ft button {
  padding:20px 25px;
  border:none;
  background-color:#fff;
  opacity:0.6;
  }
#ft button:hover {
  background-color:#ddd;
  }
.h {
  visibility:hidden;
  opacity:0.1;
  transition: all 0.8s ease;
  }
.c {
  visibility:visible;
  opacity:1;
  }
.g {
  opacity:0.5;
  }
@media screen and (orientation:landscape) {
h2 {
  margin:0.6em 0;
  }
#sb {
  padding:0px 40px;
  }
  }
</style>
</head>
<body>
<div id=time></div>
<div id=vid></div>
<div id=ft></div>
<audio id=aud preload=metadata><source src="a004000.mp3" type="audio/mpeg"></audio>
<script>
const cnta=[`# Diabetes Nutrition Program
## Questions and Answers
<BPC>
Dr. Wali Omer

# Diabets
Not just elevated blood sugar
If not treated:
* Brain
* Eyes
* Heart
* Kidney
* Feet
* Reproductive system

# 3 Questions
* What is the cause of diabetes?
* Can diabetes be treated?
* What food are bad for diabetes?

# First Question
What is the main cause of diabetes?
() Genetic
() Psychological conditions (anxiety, stress, fear, depression...)
() Eating sweets
() Eating fat
() Obesity
() Pregnancy
() Others: ___

# Second Question
Can diabetes be "treated"?
() No
() Yes: ___

# Third Question
Which of the following food is most harmful for diabetes?
() Sugar <img>
() Dates <img>
() Honey <img>
() Wheat bread <img>
() Barely bread <img>
() Rice <img>
() Lentil <img>
`,`# به‌رنامه‌ى خۆراک بۆ نه‌خۆشى شه‌کره‌
## پرسیار و وه‌ڵام
<BPC>
د. وه‌لى عومه‌ر

# نه‌خۆشى شه‌کره‌
ته‌نها به‌رز بوونه‌وه‌ى شه‌کر له‌ خوێن نیه‌.
ئه‌گه‌ر چاره‌سه‌ر نه‌کرێ:
* مێشک
* چاو
* دڵ
* گورچیله‌
* فشارى خوێن
* برین
* پێ
* ئه‌ندامى زاوزێ
* ...

# ٣ پرسیار
* هۆى شه‌کره‌ چیه‌؟
* ئایا شه‌کره‌ چاره‌سه‌رى هه‌یه‌؟
* کامه‌ خۆراک بۆ شه‌کره‌ خراپه‌؟

# پرسیارى یه‌که‌م
هۆى سه‌ره‌کى نه‌خۆشى شه‌کره‌ چیه‌؟
() بۆماوه‌یی (ویراسه‌)
() بارى ده‌روونى (خه‌م، دڵه‌ڕاوکێ، ترس، تاسان...)
() خواردنى شیرینی
() خواردنى چه‌ورى
() قه‌ڵه‌وى
() دووگیانى
() هى تر: ___

# پرسیارى دووه‌م
ئایا نه‌خۆشى شه‌کره‌ "چاره‌سه‌رى"ی هه‌یه‌؟
() نه‌خێر
() به‌ڵێ: ___

# پرسیارى سێیه‌م
کامه‌ له‌م خۆراکانه‌ له‌ هه‌موویان خراپتره‌ بۆ نه‌خۆشى شه‌کره‌ (هه‌مان بڕ)؟
() شه‌کر <img>
() خورما <img>
() هه‌نگوین <img>
() نانى گه‌نم (نانى سپی) <img>
() نانى جۆ (نانى سوکه‌رى) <img>
() برنج <img>
() نیسک <img>
`,`# البرنامج الغذائي لمرضى السكري
## سؤال و جواب
<BPC>
د. ولي عمر

# مرض السكري
ليس فقط ارتفاع السكر في الدم
اذا لم تعالج:
* الدماغ
* العيون
* القلب
* الكلية
* القدم
* الاعضاء التناسلية

# ٣ أسئلة
* ما هو سبب مرض السكري؟
* هل هناك "علاج" للسكري؟
* ما هي الاغذية الضارة للسكري؟

# السؤال الاول
ماهو السبب الرئيسي لمرض السكري؟
() الوراثة
() الحالة النفسية (القلق، الخوف، الصدمة)
() الحلويات
() الدهونيات
() زيادة الوزن
() الحمل
() أخرى: ___

# السؤال الثاني
هل هناك "علاج" لمرض السكري؟
() كلا
() نعم: ___

# السؤال الثالث
ماهي الاغذية الاكثر ضررا لمرضي السكري مما يلي؟
() السكر <img>
() التمر <img>
() العسل <img>
() خبز الحنطة (الخبز الابيض) <img>
() خبز الشعير (خبز السكري) <img>
() الرز <img>
() العدس <img>
`];

const cont=["Continue","به‌رده‌وام به‌","استمر"];
var i=0;
var dir="rtl";
var cnt=cnta[1];
var step=0;
var steps;
const aud=document.getElementById("aud");
const vid=document.getElementById("vid");
const ft=document.getElementById("ft");
const bp=document.getElementById("bpl");

const BPC=`<div id=dimg><img id=title_img src=dm_test.jpg><svg id="vpb" viewBox="0 0 200 200" alt="Play video">
  <circle cx="100" cy="100" r="90" fill="none" stroke-width="15" stroke="#000"></circle>
  <polygon points="70, 55 70, 145 145, 100" fill="#000"></polygon></svg></div>`;
const BPL=`<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"></path><path d="M8 5v14l11-7z"></path></svg>`;
const BPS=`<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
const FTB=`<button id=more onclick="get_more()">
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
</button>
<button id=bpl onclick="start_slides()">${BPL}</button>
<button onclick="next_slide()">
 <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z"></path></svg>
</button>`;
// <button onclick="prev_slide()">
//  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
// </button>


window.onload=load_page(0);

function load_page(f){
  var rv="";
  sla=cnt.split("\n\n");
  rv=format_text(sla[i],f);
  if(dir=="ltr") document.body.style="font-family:noto;direction:ltr;";
  vid.innerHTML=rv;
  ft.innerHTML=FTB;
  if(i==0) document.getElementById("vpb").addEventListener("click", start_slides)
  if(f==0){
    aud.addEventListener("timeupdate", audio_update, false);
    aud.addEventListener("ended", audio_ended, false);
    vid.addEventListener("click", vid_click, false);
    }
  ft.style.bottom="-70px";
  aud.src=`a00400${i}.mp3`;
  steps=document.getElementsByClassName("h");
  }

document.addEventListener("keydown",event=>{
//   console.log(event.key, event.keyCode);
  if (event.key==="ArrowRight") next_slide();
  if (event.ctrlKey && event.key==="ArrowRight") next_step();
  if (event.ctrlKey && event.key==="ArrowLeft") prev_step();
  if (event.key==="ArrowLeft") prev_slide();
  // if (event.key==="Escape") document.getElementById("ftb").style.bottom = "-50px";
  if (event.key===" ") start_slides();
  if (event.key==="p") start_slides();
  
  if (event.key==="a") {dir="rtl"; cnt=cnta[2]; load_page(1);}
  if (event.key==="k") {dir="rtl"; cnt=cnta[1]; load_page(1);}
  if (event.key==="e") {dir="ltr"; cnt=cnta[0]; load_page(1);}
  });

function next_step(){
  // console.log(i,step,steps.length,steps);
  if(step==steps.length) next_slide();
  steps[step].classList.add("c");
  if(step<steps.length) step++; 
  }

function next_slide(){
  if(i<cnt.split("\n\n").length-1) i++;
  step=0;
  load_page(1);
  if(aud.paused) aud.play();
  // cont_slides();
  console.log(i,step,steps.length,steps);
  }

function prev_slide(){
  if(i>0) i--;
  step=0;
  load_page(1);
  if(i==0) document.getElementById("vpb").style="visibility:hidden;";
  // if(aud.paused) aud.play();
  console.log(i,step,steps.length,steps);
  }

function format_text(t,f){
  var rv="";
  var fcpp=0;
  t=t.replaceAll("ک","ك");
  // console.log(sla);
  rv+=`<s-l>`;
  const sna=t.split("\n"); // sentence array
  sna.forEach((s,j)=>{
    var fcl=s.substring(0,1)=="<"?1:0; // first char less than
    var fch=s.substring(0,2)=="# "?1:0; // first char hash
    var fcd=s.substring(0,3)=="## "?1:0; // first 2 hash
    var fca=s.substring(0,2)=="* "?1:0; // first char asterisk
    var fcp=s.substring(0,3)=="() "?1:0; // first 2 char parenthesis
    var fcf=fch+fca+fcp+fcd+fcl;
    s=s.replaceAll("## ","");
    s=s.replaceAll("# ","");
    s=s.replaceAll("* ","");
    s=s.replaceAll("()","");
    s=s.replaceAll("<img>",`<img src=p${i}${j}.jpg id=${i}${j}>`);
    s=s.replaceAll("___","<input type=text id=it>");
    var cls=f==1?" class=h":"";
    if(fch==1){
      if(i==0) rv+=`<h1${cls}>${s}</h1>`; else rv+=`<h2${cls}>${s}</h2><div id=sb>`;
      } 
    if(fcd==1){
      if(i==0) rv+=`<s-t${cls}>${s}</s-t>`;
      } 
    if(fcl==1) rv+=s;
    // add ul
    if(j>0 && sna[j].substring(0,1)=="*"  && sna[j-1].substring(0,1)!="*") rv+="<ul>";
    if(j>0 && sna[j].substring(0,1)!="*"  && sna[j-1].substring(0,1)=="*") rv+="</ul>";
    if(fca==1) rv+=`<li${cls}>${s}</li>`;
    if(fcp==1) rv+=`<label ${cls} onclick="rc(${i}${j})"><input type=radio id=${i}${j} name=q${i}>${s}</label><br>`;
    if(fcp==1) fcpp=1;
    if(fcf==0 && i==0){
      rv+=`<a-u${cls}>${s}</a-u>`;
      }
    if(fcf==0 && i>0){
      rv+=`<p${cls}>${s}</p>`;
      }
    // console.log(i,j,fch,fca,fcp,s);
    });
  if(i==0) {
    rv=rv.replaceAll("<BPC>",BPC);
    }
  rv+="</div>";
  if(fcpp==1) rv+=`<button id=cb onclick="cont_slides()">${cont[1]}</button>`;
  rv+="</s-l>";
  return rv;
  }

function start_slides(){
  if(i==0) prev_slide();
  if(i==0) document.getElementById("vpb").style="visibility:hidden;";
  if(aud.paused) aud.play(); else aud.pause();
  hide_menu();
  // document.getElementById("aud").play();
  }

function cont_slides(){
  next_slide();
  if(aud.paused) aud.play();
  // document.getElementById("aud").play();
  }

function rc(id){
  console.log(id);
  document.getElementById("cb").style="opacity:1;";
  switch (id) {
    case 38:
    case 43:
      document.getElementById("it").focus();
      break;
  
    default:
      break;
  }
  }

const sta=[
  [0.2,3.6,5.1],
  [0.2,1.2,5.3,11,12.7,14.9,16.4,18.5,21,25,27.2,31.7],
  [0.2,20,23.5,27.5,35],
  [0.2,3,5,6,7,8,9,10,11],
  [0.2,2,3,4],
  [0.2,3.2,9.8,12.9,14.3,15.9,18.8,23.6,24.9]
  ];
// console.log(sta);
function audio_update() {
  var ta=sta[i];
  var t=aud.currentTime;
  document.getElementById("time").innerHTML=i+":"+step+":"+t.toFixed(1);
  for (k in ta) {
  // for(k=0;k<mx;k++) {
  // ta.forEach((v,k)=>{
  // var k=0;
  // while (ta[k]<t) {
    // console.log(k,ta[k],t,i,ta);
    if(t<ta[k]) break;
    delete ta[k];
    next_step();
    }
  }  

const stopa=[3,4,5];
function audio_ended() {
  if(stopa.includes(i)){
    console.log("Continue");
  } else {
    next_slide();
    aud.play();
    }
  }

function vid_click(){
  if(ft.style.bottom=="-70px") {
    ft.style.bottom="0px";
    setTimeout(()=>{hide_menu();}, 3000);
    } else hide_menu();
  if(aud.paused) document.getElementById("bpl").innerHTML=BPL; else document.getElementById("bpl").innerHTML=BPS;
  }

function get_more(){
  console.log("more");
  }

function hide_menu(){
  ft.style.bottom="-70px";
  }

class Slide extends HTMLElement{
  constructor(){super();}
  }
class SubTitle extends HTMLElement{
  constructor(){super();}
  }
class SlideAuthor extends HTMLElement{
  constructor(){super();}
  }
class SlideBody extends HTMLElement{
  constructor(){super();}
  }
window.customElements.define("s-l", Slide);
window.customElements.define("s-t", SubTitle);
window.customElements.define("a-u", SlideAuthor);
window.customElements.define("s-b", SlideBody);
</script>
</body>
</html>

<!--
FEATURES
* get markdown text (or similar) and make into slideshow which moves with cues from an mp3 file
* put slides into proper format like poster automatically
* support for rtl and ltr
* support introducing elements one by one and gray out
* support a highlighter or indicator similar to a pen?
* ask questions and record their answer in a database conntected to their profile
* connect slide narration with slide?
* make caption file (srt) automatically

TODO
* write script for each slide
* add audio for each slide
* save answers
* give feedback based on answers
* add time prgress above lower menu
* add dob, years of dm, hb1c, htn (see dm sheet)
* Save data first local storage then upload to server
* Social media for DM patients? Group support?

DONE
* add pictures for food (next to line)

STEPS
* Load first page with Play Button
* On Button Click: play slide 1 audio 
* On Audio Timer: loop through array of time for fisrt slide -> show next step
* On Finished mp3: advance to next slide and repeat previous "step"
-->